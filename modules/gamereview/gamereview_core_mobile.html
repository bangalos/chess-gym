<!doctype html>
<html>
    <head>
        <!--<meta name="viewport" content="width=600,user-scalable=no" />-->
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        
        <meta http-equiv="cache-control" content="max-age=0" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="0" />
        <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
        <meta http-equiv="pragma" content="no-cache" />
        
        <title>Game Review Module</title>
        
    </head>
    <body>
        
        <!-- start example HTML --->
        <!-- <div>Memorable information: <span id="memorable"></span></div>-->
        <!--<p>Enter your move on the board in <span id="countdown-holder">X</span> seconds</p>-->
        
        <div style="margin-top:10%;clear:both"></div>
        
        <div id="player-b-img-div">
            <img id="player-b-img" class="player" height="70"></img>
        </div>
        
        <div id="player-b-name-position">
            <label id="player-b-name" style="font-size:40px;font-weight:bold"></label>
        </div>
        
   <!--     <div style="overflow:hidden">
            <div id = "left-panel">
                <table class="info-table">
                    <colgroup>
                        <col span="1" style="width: 38%;">
                            <col span="1" style="width: 62%;">
                                </colgroup>
                    
                    <tr>
                        <td>Game Profile </td>
                        <td><span id="player_name"></span>
                            
                            <div class="tooltip">
                                <img id="info-img" height="15"></img>
                                <span id="info-tooltip" class="tooltiptext"></span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>User Move </td>
                        <td><span id="user_move_html"></span></td>
                    </tr>
                    <tr>
                        <td>Game Move </td>
                        <td><span id="game_move_html"></span></td>
                    </tr>
                    <tr>
                        <td>Plies Remaining </td>
                        <td><span id="plies_remaining_html"></span></td>
                    </tr>
                    <tr>
                        <td>Your Score </td>
                        <td><span id="your_score_html"></span></td>
                    </tr>
                    <tr>
                        <td>Status </td>
                        <td><span id="status"></span></td>
                    </tr>
                    <tr>
                        <td>FEN </td>
                        <td><span id="fen"></span></td>
                    </tr>
                    <tr>
                        <td>PGN </td>
                        <td style="word-wrap:break-word"><span id="pgn"></span></td>
                    </tr>
                    <!--        <tr>
                     <td>Mobility for pieces: </td>
                     <td><label id="mobilityStr"></label> </td>
                     </tr>
                     <tr>
                     <td>Total no. of spaces to move to in opponent's camp: </td>
                     <td><label id="opponentSpacesCnt"></label></td>
                     </tr> -->
               <!-- </table>
            </div> -->
            
            <div id="board">
                
            </div>
            
        </div>
        
        <div id= "player-w-name-position">
            <label id="player-w-name" style="font-size:40px;font-weight:bold"></label>
        </div>
        
        <div id="player-w-img-div">
            <img id="player-w-img" class="player" height="70"></img>
        </div>
        
        <div id="progressBar"><div></div></div>
        
        <div class="footer">
                <div id="control-pnl-left">
                    <img id="refreshBtn" style="height:60px;" onclick="refresh()"></img>
                </div>
                <div id="control-pnl-center">
                    <img id="flipBtn" style="height:60px;" onclick="flipTheBoard()"></img>
                    <img id="pauseBtn" style="height:60px;margin-left:5%" onclick="pause()"></img>
                </div>
                <div id="control-pnl-right">
                    <a href="SECRETNEXT">
                    <img id="nextBtn" style="height:60px;" onclick="window.location = SECRETNEXT"></img>
                    </a>
                </div>
            <!--<div id="nextBtnDiv">
                <img id="nextBtn" style="height:60px" onclick="window.location = SECRETNEXT"></img>
            </div>
            <a href="SECRETNEXT">Next Game</a> -->
            <!--   <p>Score: <span id="score"></span></p>
             <p>Status: <span id="status"></span></p> -->
            <!--
             <div id="circle_black" style="display:none"></div>
             <div id="circle_white" style="display:none"></div>
             -->
            <!--     <p>FEN: <span id="fen"></span></p>
             <p>PGN: <span id="pgn"></span></p>
             <p>Mobility for pieces: <label id="mobilityStr"></label></p>
             <p>Total no. of spaces to move to in opponent's camp: <label id="opponentSpacesCnt"></label></p>
             <button onclick="flipTheBoard()">Flip Board</button>
             <button id="pauseBtn" onclick="pause()">Pause</button> -->
            
        </div>
        
        
        <svg id="arrow-svg" style="width:100%;">
            
            <defs>
                <marker id="arrow" markerWidth="13" markerHeight="13" refx="2" refy="6" orient="auto">
                    <path id="arrow-head-path" d="M-1,2 L-1,11 L6,6 z" style="fill:chartreuse;" />
                </marker>
            </defs>
            
            <path id="arrow-path" d="" style="stroke:chartreuse;stroke-width:2.25px;fill:none;marker-end: url(#arrow);"
            />
            
        </svg>
        
        <!-- end example HTML --->
        <script>
            
            function isIPAddress(hname){
                validIp = false;
                ipParts = hname.split(".");
                if(ipParts.length==4){
                    for(i=0;i<4;i++){
                        
                        theNum = parseInt(ipParts[i]);
                        if(theNum >= 0 && theNum <= 255){}
                        else{break;}
                    }
                    if(i==4)validIp=true;
                }
                return validIp;
            }
        
            function isDevo(hname){
                return hname == 'localhost' || isIPAddress(hname);
            }
        
            function getUrlRoot() {
                return isDevo(window.location.hostname) ? '/drupal' : '';
            }
        
            function addStylesheet(href) {
                var s = document.createElement('link');
                s.setAttribute('rel', 'stylesheet');
                s.setAttribute('href', getUrlRoot() + href);
                document.head.appendChild(s);
            }
        
            function addScript(src) {
                var s = document.createElement('script');
                s.setAttribute('src', getUrlRoot() + src);
                document.head.appendChild(s);
            }
        
            addStylesheet("/sites/default/files/chessgym/css/chessboard.css");
            addStylesheet("/sites/default/files/chessgym/css/chessgym_mobile.css");
        
            addScript("/sites/default/files/chessgym/js/chess.js");
            addScript("/sites/default/files/chessgym/js/json3.min.js");
            addScript("/sites/default/files/chessgym/js/jquery-1.10.1.min.js");
            addScript("/sites/default/files/chessgym/js/chessboard.js");
            addScript("/sites/default/files/chessgym/js/countdown.js");
        
        </script>
        
        <script defer='defer'>
            // required for debugging
            //            document.onmousemove = function(e){
            //                var x = e.pageX;
            //                var y = e.pageY;
            //                console.log("X is "+x+" and Y is "+y);
            //            };
            
            var INIT_TIMER = 15;
            var memorable_init = 'SECRETGENBG';
            var pgn_init = ['[Event "Chess Gym Game Review"]',
                            '',
                            'SECRETPGN'];
                            
                            var all_moves,moveThreshold, counter, board, game, scratch_game, fenEl, pgnEl, memEl, paused = 0, savedCall, gameInfo;
                            var user_input_move = 'blank';
                            var fifteenTimer = 1;
                            var keymove_score = "Neutral";
                            var your_score= 0;
                            var total_moves = 0;
                            var game_ended = 0;
                            var plies_remaining = 0;
                            
                            var gameInfo = memorable_init.split("<br/>");
                            var map = {};
                            
                            for (i=0;i<gameInfo.length;i++) {
                                var strsplt = gameInfo[i].split("\"");
                                map[strsplt[0].replace('[', '').trim()] = strsplt[1];
                            }
        
        var init = function() {
            game = new Chess();
            scratch_game = new Chess();
            statusEl = $('#status');
            fenEl = $('#fen');
            pgnEl = $('#pgn');
            //   memEl = $('#memorable');
            // memEl.html(memorable_init);
            //scoreEl = $('#score');
            userMoveEl = $('#user_move_html');
            gameMoveEl = $('#game_move_html');
            pliesEl = $('#plies_remaining_html');
            scoreEl = $('#your_score_html');
            var player_name = getKey('White').concat(" Vs ").concat(getKey('Black'));
            playerNameEl = $('#player_name');
            
            //        $('#cnvsdiv').detach();
            
            
            // do not pick up pieces if the game is over
            // only pick up pieces for the side to move
            
            var onDragStart = function(source, piece, position, orientation) {
                if (game.game_over() === true ||
                    (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
            };
            
            var onDrop = function(source, target) {
                // see if the move is legal
                var move = game.move({
                                     from: source,
                                     to: target,
                                     promotion: 'q' // NOTE: always promote to a queen for example simplicity
                                     });
                                     
                                     // legal move
                                     if (move != null) {
                                         var throwaway_history = game.history();
                                         user_input_move = throwaway_history[throwaway_history.length-1];
                                         game.undo();
                                         if (counter >= moveThreshold) {
                                             drawArrow(source, target, 0);
                                             real_move_to = all_moves[counter]
                                             setTimeout("updateArrow('"+(real_move_to.endsWith(target))+"');", 1500);
                                         }
                                         
                                         return 'snapback';
                                     }
                                     // illegal move
                                     if (move === null) return 'snapback';
                                     updateStatus();
            };
            
            // update the board position after the piece snap
            // for castling, en passant, pawn promotion
            var onSnapEnd = function() {
                board.position(game.fen());
            };
            
            var updateStatus = function() {
                var status = '';
                
                var moveColor = 'White';
                if (game.turn() === 'b') {
                    moveColor = 'Black';
                }
                
                // checkmate?
                if (game.in_checkmate() === true) {
                    status = 'Game over, ' + moveColor + ' is in checkmate.';
                }
                
                // draw?
                else if (game.in_draw() === true) {
                    status = 'Game over, drawn position';
                }
                
                else if (game_ended == 1) {
                    status = 'Game over';
                }
                
                // game still on
                else {
                    status = moveColor + ' to move';
                    
                    // check?
                    if (game.in_check() === true) {
                        status += ', ' + moveColor + ' is in check';
                    }
                }
                
                if (keymove_score == "Success") {
                    your_score++;
                    total_moves++;
                    keymove_score = "Neutral";
                }
                if (keymove_score == "Fail") {
                    total_moves++;
                    keymove_score = "Neutral";
                }
                plies_remaining = all_moves.length - counter;
                //        score_html = "User move: " + user_input_move + "<br/>";
                //        score_html += "Game move: " + all_moves[counter-1] + "<br/>";
                //        score_html +=  "Plies remaining: " + plies_remaining + "<br/>Your Score: " + your_score + "/" + total_moves;
                
                user_move_html = user_input_move;
                game_move_html = all_moves[counter-1];
                plies_remaining_html = plies_remaining;
                your_score_html = your_score + "/" + total_moves;
                
                statusEl.html(status);
                fenEl.html(game.fen());
                pgnEl.html(game.pgn());
                //scoreEl.html(score_html);
                userMoveEl.html(user_move_html);
                gameMoveEl.html(game_move_html);
                pliesEl.html(plies_remaining_html);
                scoreEl.html(your_score_html);
                playerNameEl.html(player_name);
                
                if (counter > moveThreshold) {
                    if (moveColor == "Black") {
                        $('#player-w-img').stop();
                        $('#player-w-img').css({ opacity: 1.0 });
                        blink($('#player-b-img'), 'slow');
                    } else {
                        $('#player-b-img').stop();
                        $('#player-b-img').css({ opacity: 1.0 });
                        blink($('#player-w-img'), 'slow');
                    }
                }
                
                //        var blackPossibleMoves = filterMovesForSide(game.moves({legal: true, verbose: true, turn: 'b'}), 'b'); // all black moves
                //        var whitePossibleMoves = filterMovesForSide(game.moves({legal: true, verbose: true, turn: 'w'}), 'w'); // all white moves
                //        var allPossibleMoves = []
                //        allPossibleMoves.concat(blackPossibleMoves, whitePossibleMoves);
                var myPossibleMoves = filterMovesForSide(game.moves({legal: true, verbose: true}), game.turn());
                
                var mobility = getMobilityForPieces(myPossibleMoves);
                
                var mobilityStr = "";
                $(':not([data-square=""])').removeClass("highlight-mobility");
                for (var m = 0; m < mobility.length; m++) {
                    var pieceMove = mobility[m]["move"];
                    var aMobilityStr = pieceMove.piece + "/" + pieceMove.to + "=" + mobility[m]["cnt"];
                    mobilityStr = mobilityStr + aMobilityStr + ";";
                    $('*[data-square=' + pieceMove.from + ']').addClass("highlight-mobility");
                }
                
                $("#mobilityStr").html(mobilityStr);
                
                var movesByUniqueSpaces = filterMovesOnUniqueSpaces(myPossibleMoves);
                var opponentSpaces = filterMovesInOpponentCamp(movesByUniqueSpaces);
                $("#opponentSpacesCnt").html(opponentSpaces.length);
            };
            
            var cfg = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            
            function highlightLastMove(move) {
                $(':not([data-square=""])').removeClass("highlight-last-move");
                $('*[data-square=' + move.from + ']').addClass("highlight-last-move");
                $('*[data-square=' + move.to + ']').addClass("highlight-last-move");
            }
            
            var makeMoveUntil = function () {
                if (!paused) {
                    var moveInfo = game.move(all_moves[counter]);
                    highlightLastMove(moveInfo);
                    board.position(game.fen());
                    counter++;
                    if (counter < moveThreshold) {
                        setTimeout(makeMoveUntil, 1000);
                    } else {
                        setTimeout(interactiveMove, 1000);
                    }
                    updateStatus();
                } else {
                    savedCall = function (){makeMoveUntil()};
                }
            }
            
            var interactiveMove = function () {
                if (!paused) {
                    var moveInfo = game.move(all_moves[counter]);
                    highlightLastMove(moveInfo);
                    board.position(game.fen());
                    counter++;
                    updateStatus();
                    fifteenTimer = INIT_TIMER;
                    keymove_score = "Neutral";
                    $('#progressBar').show();
                    progress(fifteenTimer);
                    setTimeout(checkEverySecond, 1000);
                    $("#countdown-holder").html(fifteenTimer);
                    user_input_move = 'blank';
                } else {
                    savedCall = function (){interactiveMove()};
                }
            }
            
            var checkEverySecond = function (){
                
                if (!paused) {
                    fifteenTimer--;
                    $("#countdown-holder").html(fifteenTimer);
                    progress(fifteenTimer);
                    if (user_input_move != 'blank') {
                        if (user_input_move == all_moves[counter]) {
                            keymove_score = "Success";
                        } else {
                            keymove_score = "Fail";
                        }
                        var moveInfo = game.move(all_moves[counter]);
                        highlightLastMove(moveInfo);
                        board.position(game.fen());
                        counter++;
                        updateStatus();
                        if (counter+1 < all_moves.length) {
                            setTimeout(interactiveMove, 3000);
                        } else {
                            game_ended = 1;
                        }
                    } else {
                        if (fifteenTimer > 0) {
                            if (counter+1 >= all_moves.length) {
                                game_ended = 1;
                            }
                            setTimeout(checkEverySecond, 1000);
                        } else {
                            var moveInfo = game.move(all_moves[counter]);
                            highlightLastMove(moveInfo);
                            board.position(game.fen());
                            counter++;
                            keymove_score = "Fail";
                            if (counter+1 >= all_moves.length) {
                                game_ended = 1;
                            }
                            updateStatus();
                            if (counter+2 < all_moves.length) {
                                setTimeout(interactiveMove, 3000);
                            }
                        }
                    }
                } else {
                    savedCall = function (){checkEverySecond()};
                }
                
            }
            board = ChessBoard('board', cfg);
            scratch_game.load_pgn(pgn_init.join('\n'));
            all_moves = scratch_game.history();
            initializeUIComponents();
            counter = 0;
            moveThreshold = SECRETTHRESHOLD;
            makeMoveUntil();
            updateStatus();
        }; // end init()
        
        
        // Function to get value of a key from a map
        function getKey(k) {
            return map[k];
        }
        
        // Function to Flip the board
        function flipTheBoard() {
            
            // Filp the board
            board.orientation('flip');
            
            // Flip player names
            var divOneText = $('#player-w-name').html();
            var divTwoText = $('#player-b-name').html();
            
            if (divOneText != '' && divTwoText != '') {
                $('#player-w-name').html(divTwoText);
                $('#player-b-name').html(divOneText);
            }
            
            // Flip player image
         /*   var divOneImg = $('#player-w-img').html();
            var divTwoImg = $('#player-b-img').html();
            
            if (divOneImg != '' && divTwoImg != '') {
                $('#player-w-img').html(divTwoImg);
                $('#player-b-img').html(divOneImg);
            }*/
            
            if (counter > moveThreshold) {
                console.log(moveColor);
                if (moveColor == "Black") {
                    $('#player-w-img').stop();
                    $('#player-w-img').css({ opacity: 1.0 });
                    blink($('#player-b-img'), 'slow');
                } else {
                    $('#player-b-img').stop();
                    $('#player-b-img').css({ opacity: 1.0 });
                    blink($('#player-w-img'), 'slow');
                }
            }
            
        }
        
        // TODO: remove
        function refresh() {
            location.reload();
        }
        
        // Function to pause or resume the game
        function pause() {
            if (paused) {
                paused = 0;
                //        $("#pauseBtn").html("Pause");
                $('#pauseBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/pause.png');
                savedCall();
                savedCall = function() {};
            }
            else
            {
                paused = 1;
                //        $("#pauseBtn").html("Resume");
                $('#pauseBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/play.png');
            }
        }
        
        function progress(timer) {
            var boardWidth = $('.board-b72b1').width();
            var progressBarWidth = (boardWidth / INIT_TIMER) * (INIT_TIMER - timer);
            $('#progressBar').find('div').animate({ width: progressBarWidth }, 500).html("<label style=\"font-size:25px;font-weight:bold;text-align:center;margin-left:2px;margin-right:2px;color:black\">"+timer + "</label>");
            
            if (progressBarWidth == (boardWidth / INIT_TIMER) * INIT_TIMER) {
                setTimeout("$('#progressBar').hide();", 1000);
            }
        }
        
        // Function to get all the legal moves
        function filterMovesForSide(moves, by) {
            var filteredMoves = [];
            for (var i = 0; i < moves.length; i++) {
                if (moves[i].color == by) {
                    filteredMoves.push(moves[i]);
                }
            }
            return filteredMoves;
        }
        
        
        
        // Function to calculate unique spaces that moves can be made to
        function getMobilityForPieces(moves) {
            var mobility = [];
            var MOBILITY_THRESHOLD = 3;
            var piecesMap = {};
            
            for (var i = 0; i < moves.length; i++) {
                if(moves[i].piece != 'p') {
                    var pieceDataKey = moves[i].piece + ":" + moves[i].from;
                    if(pieceDataKey in piecesMap) {
                        piecesMap[pieceDataKey].push(moves[i]);
                    }
                    else {
                        piecesMap[pieceDataKey] = [moves[i]];
                    }
                }
            }
            
            for (var key in piecesMap) {
                if (piecesMap[key].length < MOBILITY_THRESHOLD) {
                    var pieceDataArr = key.split(":");
                    for (var l = 0; l < piecesMap[key].length; l++) {
                        pieceMobilityData = {};
                        pieceMobilityData["move"] = piecesMap[key][l];
                        pieceMobilityData["cnt"] = piecesMap[key].length;
                        mobility.push(pieceMobilityData);
                    }
                }
            }
            
            return mobility;
        }
        
        // Function to calculate unique spaces that moves can be made to
        function filterMovesOnUniqueSpaces(moves) {
            var filteredMoves = [];
            var foundSpaces = [];
            
            for (var i = 0; i < moves.length; i++) {
                if (foundSpaces.indexOf(moves[i].to) < 0) { // contains unique or not
                    filteredMoves.push(moves[i]);
                    foundSpaces.push(moves[i].to);
                }
            }
            
            return filteredMoves;
        }
        
        // Function to calculate spaces in opponent's camp
        function filterMovesInOpponentCamp(moves) {
            var filteredMoves = [];
            for (var i = 0; i < moves.length; i++) {
                if (parseInt(moves[i].to.charAt(1), 10) > 4) { // check if rank greater than 4 to verify if on opponent's side
                    filteredMoves.push(moves[i]);
                }
            }
            return filteredMoves;
        }
        
        function initializeUIComponents() {
            var boardEl = $('.board-b72b1');
            var chessboardEl = $('.chessboard-63f37');
            chessboardEl.css('position', 'absolute');
            chessboardEl.css('z-index', 0);
            
            $('#left-panel').height(boardEl.height());
            $('#progressBar').width(boardEl.width());
            
            $('#arrow-svg').height(chessboardEl.height());
            $('#arrow-svg').width(chessboardEl.width());
            $('#arrow-svg').appendTo($('#board'));
            $('#arrow-svg').css('z-index', -1);
            
            $('.player').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/player.png');
            $('#player-w-img').css({'transform': 'rotate(180deg)'});
            
            var player_w_name = getKey('White');
            $('#player-w-name').html(player_w_name);
            
            var player_b_name = getKey('Black');
            $('#player-b-name').html(player_b_name);
            
            $('#info-img').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/info_image.png');
            
            $('#info-tooltip').html(memorable_init);
            
            $('#flipBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/flip.png');
            $('#pauseBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/pause.png');
            $('#nextBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/next.png');
            $('#refreshBtn').attr('src', getUrlRoot() + '/sites/default/files/chessgym/images/info_image.png');
            
        }
        
        function updateArrow(isMoveCorrect) {
            $('#arrow-svg').css("animation", "");
            if (isMoveCorrect == 'true') {
                $('#arrow-head-path').css('fill', 'green');
                $('#arrow-path').css('stroke', 'green');
            } else {
                $('#arrow-head-path').css('fill', 'red');
                $('#arrow-path').css('stroke', 'red');
            }
            $('#arrow-path').stop();
            $('#arrow-path').css({ opacity: 1.0 });
            $('#arrow-head-path').stop();
            $('#arrow-head-path').css({ opacity: 1.0 });
            setTimeout("$('#arrow-svg').css('zIndex', -1);$('.chessboard-63f37').css('zIndex', 0);", 2000);
        }
        
        function drawArrow(from, to, width ) {
            fromDiv = $('*[data-square=' + from + ']');
            fromDivOffset = fromDiv.offset();
            fromX = parseInt(fromDivOffset.left + fromDiv.width() / 2);
            fromY = parseInt(fromDivOffset.top + fromDiv.height() / 2);
            
            toDiv = $('*[data-square=' + to + ']');
            toDivOffset = toDiv.offset();
            toX = parseInt(toDivOffset.left + toDiv.width() / 2);
            toY = parseInt(toDivOffset.top + toDiv.height() / 2);
            
            var arrowSvgOffset = $('#arrow-svg').offset();
            
            var path = document.getElementById('arrow-path');
            path.setAttribute('d', 'M'+(fromX-arrowSvgOffset.left)+','+(fromY-arrowSvgOffset.top)+' L'+(toX-arrowSvgOffset.left)+','+(toY-arrowSvgOffset.top));
            
            $('#arrow-svg').css("zIndex", 0);
            $('.chessboard-63f37').css("zIndex", -1);
            $('#arrow-head-path').css('fill', 'yellow');
            $('#arrow-path').css('stroke', 'yellow');
            blink($('#arrow-path'), 'fast');
            blink($('#arrow-head-path'), 'fast');
        }
        
        function blink(selector, speed){
            $(selector).fadeOut(speed, function(){
                                $(selector).fadeIn(speed, function(){
                                                   blink(selector, speed);
                                                   });
                                });
        }
        
        (function() {
         var nTimer = setInterval(function() {
                                  if (window.jQuery) {
                                  $(document).ready(init);
                                  clearInterval(nTimer);
                                  }
                                  }, 100);
         })();
         
            </script>
    </body>
</html>
